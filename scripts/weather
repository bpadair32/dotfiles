#!/usr/bin/env bash
#
# weather - Display current weather for Waybar
#
# Shows weather icon, temperature, and alerts from wttr.in + NWS
# Output format: JSON for Waybar custom module
#

set -euo pipefail

# Configuration - customize these
# Override with environment variables when traveling:
#   export WEATHER_LOCATION="41.8781,-87.6298"
#   export WEATHER_LOCATION_NAME="Chicago, IL"
LOCATION="${WEATHER_LOCATION:-40.1842,-82.8838}"  # Default: Galena, OH
LOCATION_NAME="${WEATHER_LOCATION_NAME:-Galena, OH}"
UNITS="${WEATHER_UNITS:-F}"  # F or C

# Cache settings (avoid hitting API too frequently)
CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/waybar-weather"
CACHE_FILE="$CACHE_DIR/weather.json"
ALERTS_CACHE="$CACHE_DIR/alerts.json"
CACHE_MAX_AGE=600  # 10 minutes

mkdir -p "$CACHE_DIR"

# Check if cache is fresh
cache_is_fresh() {
    local file="$1"
    local max_age="$2"
    if [[ -f "$file" ]]; then
        local age=$(($(date +%s) - $(stat -c %Y "$file")))
        [[ $age -lt $max_age ]]
    else
        return 1
    fi
}

# Weather code to icon mapping (wttr.in codes)
# Using nerd font weather icons
get_weather_icon() {
    local code="$1"
    case "$code" in
        113) echo "â˜€ï¸" ;;   # Sunny/Clear
        116) echo "â›…" ;;   # Partly cloudy
        119) echo "â˜ï¸" ;;   # Cloudy
        122) echo "â˜ï¸" ;;   # Overcast
        143|248|260) echo "â˜ï¸" ;;  # Fog/Mist (use cloud icon)
        176|263|266|293|296|353) echo "ğŸŒ¦ï¸" ;;  # Light rain/drizzle
        179|182|185|281|284|311|314|317) echo "ğŸŒ¨ï¸" ;;  # Sleet/freezing
        200) echo "â›ˆï¸" ;;   # Thunderstorm
        227|230) echo "ğŸŒ¬ï¸" ;;  # Blowing snow
        299|302|305|308|356|359) echo "ğŸŒ§ï¸" ;;  # Heavy rain
        320|323|326|329|332|335|338|350) echo "â„ï¸" ;;  # Snow
        368|371|374|377) echo "ğŸŒ¨ï¸" ;;  # Snow showers
        386|389|392|395) echo "â›ˆï¸" ;;  # Thunder with rain/snow
        *) echo "ğŸŒ¡ï¸" ;;  # Default
    esac
}

# Get alert severity icon
get_alert_icon() {
    local severity="$1"
    local event="$2"

    # Check if it's a warning (most severe)
    if [[ "$severity" == "Extreme" ]] || [[ "$severity" == "Severe" ]] || \
       [[ "$event" == *"Warning"* ]]; then
        echo "ğŸš¨"  # Danger icon
    # Watch or advisory
    elif [[ "$event" == *"Watch"* ]] || [[ "$event" == *"Advisory"* ]] || \
         [[ "$severity" == "Moderate" ]]; then
        echo "âš ï¸"  # Warning triangle
    else
        echo "â„¹ï¸"  # Info
    fi
}

# Fetch weather data
fetch_weather() {
    if cache_is_fresh "$CACHE_FILE" "$CACHE_MAX_AGE"; then
        cat "$CACHE_FILE"
        return
    fi

    local weather
    weather=$(curl -sf "wttr.in/${LOCATION}?format=j1" 2>/dev/null) || return 1

    if [[ -n "$weather" ]]; then
        echo "$weather" > "$CACHE_FILE"
        echo "$weather"
    fi
}

# Fetch alerts from NWS (US only)
fetch_alerts() {
    if cache_is_fresh "$ALERTS_CACHE" "$CACHE_MAX_AGE"; then
        cat "$ALERTS_CACHE"
        return
    fi

    # Use exact coordinates from LOCATION config (not nearest_area from API)
    local lat lon
    lat="${LOCATION%,*}"
    lon="${LOCATION#*,}"

    if [[ -z "$lat" ]] || [[ -z "$lon" ]]; then
        echo '{"features":[]}' > "$ALERTS_CACHE"
        echo '{"features":[]}'
        return
    fi

    local alerts
    alerts=$(curl -sf "https://api.weather.gov/alerts/active?point=${lat},${lon}" \
        -H "User-Agent: waybar-weather/1.0" 2>/dev/null) || alerts='{"features":[]}'

    echo "$alerts" > "$ALERTS_CACHE"
    echo "$alerts"
}

# Main
main() {
    # Check for jq
    if ! command -v jq &>/dev/null; then
        echo '{"text": "ğŸŒ¡ï¸ ?", "tooltip": "Error: jq not installed", "class": "error"}'
        exit 0
    fi

    # Fetch weather
    local weather
    weather=$(fetch_weather) || {
        echo '{"text": "ğŸŒ¡ï¸ --", "tooltip": "Weather: API error", "class": "error"}'
        exit 0
    }

    if [[ -z "$weather" ]]; then
        echo '{"text": "ğŸŒ¡ï¸ --", "tooltip": "Weather: No data", "class": "error"}'
        exit 0
    fi

    # Parse current conditions
    local current
    current=$(echo "$weather" | jq -r '.current_condition[0]')

    local temp humidity feels_like weather_code weather_desc
    if [[ "$UNITS" == "C" ]]; then
        temp=$(echo "$current" | jq -r '.temp_C')
        feels_like=$(echo "$current" | jq -r '.FeelsLikeC')
    else
        temp=$(echo "$current" | jq -r '.temp_F')
        feels_like=$(echo "$current" | jq -r '.FeelsLikeF')
    fi
    humidity=$(echo "$current" | jq -r '.humidity')
    weather_code=$(echo "$current" | jq -r '.weatherCode')
    weather_desc=$(echo "$current" | jq -r '.weatherDesc[0].value')

    # Get weather icon
    local weather_icon
    weather_icon=$(get_weather_icon "$weather_code")

    # Fetch alerts
    local alerts alert_count alert_text alert_icon alert_class
    alerts=$(fetch_alerts)
    alert_count=$(echo "$alerts" | jq -r '.features | length')
    alert_text=""
    alert_icon=""
    alert_class="normal"

    if [[ "$alert_count" -gt 0 ]]; then
        # Get most severe alert
        local severity event headline
        severity=$(echo "$alerts" | jq -r '.features[0].properties.severity // "Unknown"')
        event=$(echo "$alerts" | jq -r '.features[0].properties.event // "Alert"')
        headline=$(echo "$alerts" | jq -r '.features[0].properties.headline // "Weather alert active"')

        alert_icon=$(get_alert_icon "$severity" "$event")
        alert_text="$headline"

        # Set class based on severity
        if [[ "$event" == *"Warning"* ]] || [[ "$severity" == "Extreme" ]] || [[ "$severity" == "Severe" ]]; then
            alert_class="danger"
        else
            alert_class="warning"
        fi
    fi

    # Build display text (icons together, then temperature)
    local text
    if [[ -n "$alert_icon" ]]; then
        text="${weather_icon} ${alert_icon} ${temp}Â°${UNITS}"
    else
        text="${weather_icon} ${temp}Â°${UNITS}"
    fi

    # Build tooltip
    local tooltip
    if [[ -n "$alert_text" ]]; then
        tooltip="${alert_icon} ALERT: ${alert_text}\n"
        tooltip+="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    fi
    tooltip+="${LOCATION_NAME}\n"
    tooltip+="${weather_desc}\n"
    tooltip+="â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    tooltip+="Temperature: ${temp}Â°${UNITS}\n"
    tooltip+="Feels Like:  ${feels_like}Â°${UNITS}\n"
    tooltip+="Humidity:    ${humidity}%"

    # Escape for JSON
    local tooltip_escaped
    tooltip_escaped=$(echo -e "$tooltip" | sed 's/"/\\"/g' | tr '\n' '|' | sed 's/|/\\n/g')

    # Output JSON
    echo "{\"text\": \"${text}\", \"tooltip\": \"${tooltip_escaped}\", \"class\": \"${alert_class}\"}"
}

main "$@"
